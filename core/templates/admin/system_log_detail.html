{% extends "admin/base_site.html" %}

{% block content %}
<div class="admin-layout">
  <section class="admin-card">
    <div class="admin-terminal-toolbar">
      <div>
        <h1 class="admin-section-title">{{ log_title }}</h1>
        <p class="admin-muted"><code>{{ log_path }}</code> Â· {{ log_size_kb }} KB</p>
      </div>
      <div class="admin-toolbar admin-toolbar--push">
        <a class="admin-btn" href="{% url 'admin:system_logs' %}">Back</a>
        <a class="admin-btn" href="{{ app_logs_url }}">App Log</a>
        <a class="admin-btn" href="{{ audit_logs_url }}">Audit Log</a>
        <form method="post" action="{% url 'admin:system_logs_backup' log_type=log_type %}">
          {% csrf_token %}
          <button class="admin-btn" type="submit">Backup</button>
        </form>
        <form method="post" action="{% url 'admin:system_logs_clear' log_type=log_type %}" onsubmit="return confirm('Reset log ini?');">
          {% csrf_token %}
          <button class="admin-btn danger" type="submit">Reset Log</button>
        </form>
        <button id="log-refresh" class="admin-btn primary" type="button">Refresh</button>
        <label class="admin-chip">
          <input id="log-auto" type="checkbox" checked>
          Auto 5s
        </label>
      </div>
    </div>

    <pre id="log-content" class="admin-terminal">{{ log_text }}</pre>
  </section>
</div>

<script>
(function(){
  const content = document.getElementById('log-content');
  const refreshBtn = document.getElementById('log-refresh');
  const autoEl = document.getElementById('log-auto');
  const tailUrl = "{% url 'admin:system_logs_detail_tail' log_type=log_type %}";

  function escHtml(s) {
    return String(s || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;");
  }

  function colorizeLogText(raw) {
    let html = escHtml(raw);
    html = html.replace(/\b(DEBUG|INFO|WARNING|ERROR|CRITICAL)\b/g, function (m) {
      const k = m.toLowerCase();
      return '<span class="tok-level-' + k + '">' + m + "</span>";
    });
    html = html.replace(/\brid=([A-Za-z0-9\-]+)/g, '<span class="tok-rid">rid=$1</span>');
    html = html.replace(/\buser=([^\s|]+)/g, '<span class="tok-user">user=$1</span>');
    html = html.replace(/\bip=((?:\d{1,3}\.){3}\d{1,3})/g, '<span class="tok-ip">ip=$1</span>');
    html = html.replace(/\b(GET|POST|PUT|PATCH|DELETE|OPTIONS|HEAD)\b/g, '<span class="tok-method">$1</span>');
    html = html.replace(/-\&gt;\s*(\d{3})/g, function (_, code) {
      const c = Number(code);
      let klass = "tok-status-4xx";
      if (c >= 200 && c < 300) klass = "tok-status-2xx";
      else if (c >= 500) klass = "tok-status-5xx";
      return '-&gt; <span class="' + klass + '">' + code + "</span>";
    });
    html = html.replace(/\bua=([^|\n]+)/g, function (_, ua) {
      const deviceColored = ua.replace(/\b(Android|iPhone|iPad|Windows|Macintosh|Linux)\b/g, '<span class="tok-device">$1</span>');
      return '<span class="tok-ua">ua=' + deviceColored + "</span>";
    });
    return html;
  }

  function renderLog(raw){
    content.innerHTML = colorizeLogText(raw || '');
  }

  async function pull(){
    try{
      const res = await fetch(tailUrl, {credentials:'same-origin'});
      if(!res.ok) return;
      const data = await res.json();
      renderLog(data.log_text || '');
      content.scrollTop = content.scrollHeight;
    }catch(_){ }
  }

  renderLog(content.textContent || '');
  refreshBtn.addEventListener('click', pull);
  setInterval(function(){ if(autoEl.checked) pull(); }, 5000);
})();
</script>
{% endblock %}
